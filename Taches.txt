##version du bolt avec ia en bas tes different de mopn local



import { useState, useEffect, useRef } from "react";

const AssistantChat = () => {
  const [isOpen, setIsOpen] = useState(true);
  const [messages, setMessages] = useState([
    { sender: "bot", text: "Bonjour et bienvenue √† SeptimmigrationüçÅ ! üëã Je suis Marie, votre conseill√®re virtuelle. Je suis l√† pour vous accompagner dans votre projet d'immigration au Canada." }
  ]);
  const [step, setStep] = useState(0);
  const [userInput, setUserInput] = useState("");
  const [form, setForm] = useState({});
  const [isLoading, setIsLoading] = useState(false);
  const [conversationMode, setConversationMode] = useState('form'); // 'form' ou 'ai'
  const [hasDeclined, setHasDeclined] = useState(false);
  const chatBoxRef = useRef(null);
  const [hasPlayedSound, setHasPlayedSound] = useState(false);

  const questions = [
    { 
      key: "name", 
      text: "Pour mieux vous conseiller, j'aimerais d'abord apprendre √† vous conna√Ætre. Quel est votre pr√©nom et nom ?", 
      type: "text" 
    },
    {
      key: "status",
      text: "Enchant√©(e) ! Maintenant, pouvez-vous me dire quelle est votre situation professionnelle actuelle ?",
      type: "select",
      options: ["√âl√®ve / √©tudiant(e)", "Employ√©(e)", "Travailleur ind√©pendant", "Sans emploi", "Retrait√©(e)", "Autre"]
    },
    { 
      key: "email", 
      text: "Pour pouvoir vous recontacter et vous envoyer des informations utiles, quelle est votre adresse email ?", 
      type: "text" 
    },
    { 
      key: "phone", 
      text: "Merci ! Et votre num√©ro de t√©l√©phone ? (avec l'indicatif pays si vous n'√™tes pas au Canada)", 
      type: "text" 
    },
    {
      key: "program",
      text: "Excellent ! Maintenant, parlons de vos objectifs. Quel type de programme d'immigration vous int√©resse le plus ?",
      type: "select",
      options: ["Entr√©e express", "Programme des candidats des provinces (PCP)", "Permis d'√©tudes", "Regroupement familial", "Visa de travail temporaire", "Je ne sais pas encore", "Autre"]
    }
  ];

  const encouragingMessages = [
    "C'est une excellente information ! üòä",
    "Parfait, je note cela ! üìù",
    "Tr√®s bien, continuons ! üëç",
    "Merci pour cette pr√©cision ! üôè",
    "Super, j'ai bien not√© ! ‚ú®"
  ];

  // D√©tection des refus ou questions hors sujet
  const analyzeUserInput = (input) => {
    const lowerInput = input.toLowerCase();
    
    // Mots-cl√©s de refus
    const refusalKeywords = [
      'non', 'pas maintenant', 'plus tard', 'pas int√©ress√©', 'arr√™ter', 'stop',
      'ne veux pas', 'pas envie', 'laisser tranquille', 'fermer', 'partir',
      'pas le temps', 'occup√©', 'rappeler', 'pas pr√™t'
    ];

    // Questions g√©n√©rales sur l'immigration
    const immigrationKeywords = [
      'visa', 'immigration', 'canada', 'permis', 'r√©sidence', 'citoyennet√©',
      'express entry', 'pcp', '√©tudiant', 'travail', 'famille', 'conjoint',
      'd√©lai', 'co√ªt', 'prix', 'document', 'exigence', 'condition',
      'ielts', 'fran√ßais', 'anglais', 'dipl√¥me', 'exp√©rience'
    ];

    // Questions hors sujet
    const offTopicKeywords = [
      'm√©t√©o', 'sport', 'politique', 'actualit√©', 'restaurant', 'voyage',
      'film', 'musique', 'jeu', 'shopping', 'sant√©', 'm√©decin'
    ];

    const hasRefusal = refusalKeywords.some(keyword => lowerInput.includes(keyword));
    const hasImmigrationTopic = immigrationKeywords.some(keyword => lowerInput.includes(keyword));
    const hasOffTopic = offTopicKeywords.some(keyword => lowerInput.includes(keyword));

    return {
      isRefusal: hasRefusal,
      isImmigrationQuestion: hasImmigrationTopic,
      isOffTopic: hasOffTopic,
      isFormRelated: !hasRefusal && !hasImmigrationTopic && !hasOffTopic
    };
  };

  // R√©ponses IA pour les questions d'immigration
  const getImmigrationResponse = (input) => {
    const lowerInput = input.toLowerCase();
    
    if (lowerInput.includes('visa') || lowerInput.includes('permis')) {
      return "Il existe plusieurs types de visas pour le Canada : visa de visiteur, permis d'√©tudes, permis de travail, et r√©sidence permanente. Chacun a ses propres exigences. Souhaitez-vous que je vous aide √† identifier le meilleur programme pour votre situation ? üçÅ";
    }
    
    if (lowerInput.includes('d√©lai') || lowerInput.includes('temps') || lowerInput.includes('combien')) {
      return "Les d√©lais varient selon le programme : Entr√©e Express (6 mois), PCP (12-18 mois), permis d'√©tudes (4-12 semaines). Pour une √©valuation pr√©cise de votre dossier, nos conseillers peuvent vous donner un calendrier personnalis√©. Voulez-vous continuer notre √©valuation ? ‚è∞";
    }
    
    if (lowerInput.includes('co√ªt') || lowerInput.includes('prix') || lowerInput.includes('cher')) {
      return "Les frais gouvernementaux varient : Entr√©e Express (1,365$ CAD), permis d'√©tudes (150$ CAD), plus les frais de nos services d'accompagnement. Nos conseillers peuvent vous d√©tailler tous les co√ªts. Continuons-nous votre √©valuation ? üí∞";
    }
    
    if (lowerInput.includes('document') || lowerInput.includes('papier')) {
      return "Les documents requis d√©pendent de votre programme : passeport, dipl√¥mes, relev√©s de notes, preuves d'exp√©rience, tests de langue, etc. Je peux vous aider √† identifier exactement ce dont vous avez besoin. Reprenons votre √©valuation ? üìÑ";
    }
    
    if (lowerInput.includes('ielts') || lowerInput.includes('fran√ßais') || lowerInput.includes('anglais')) {
      return "Les tests de langue sont essentiels : IELTS/CELPIP pour l'anglais, TEF/TCF pour le fran√ßais. Les scores requis varient selon le programme. Nos formations peuvent vous aider √† atteindre le niveau requis ! Continuons votre √©valuation ? üó£Ô∏è";
    }
    
    return "C'est une excellente question sur l'immigration au Canada ! Nos conseillers experts peuvent vous donner des r√©ponses d√©taill√©es et personnalis√©es. Souhaitez-vous que nous continuions votre √©valuation pour mieux vous conseiller ? ü§î";
  };

  // R√©ponses pour les sujets hors immigration
  const getOffTopicResponse = () => {
    const responses = [
      "Je suis sp√©cialis√©e dans l'immigration au Canada üçÅ. Comment puis-je vous aider avec votre projet d'immigration ?",
      "C'est int√©ressant, mais je suis l√† pour vous accompagner dans votre immigration au Canada ! Avez-vous des questions sur les visas ou programmes d'immigration ? üòä",
      "Je me concentre sur l'immigration canadienne. Parlons plut√¥t de votre projet : quel type de visa vous int√©resse ? üéØ"
    ];
    return responses[Math.floor(Math.random() * responses.length)];
  };

  // R√©ponses pour les refus
  const getRefusalResponse = () => {
    const responses = [
      "Je comprends parfaitement ! üòä Si vous changez d'avis ou avez des questions sur l'immigration au Canada, n'h√©sitez pas √† revenir me voir. Bonne journ√©e ! üëã",
      "Pas de probl√®me du tout ! Je reste disponible si vous souhaitez des informations sur l'immigration canadienne plus tard. √Ä bient√¥t ! üçÅ",
      "C'est tout √† fait normal de prendre son temps. Je suis l√† quand vous serez pr√™t(e) √† explorer vos options d'immigration. Excellente journ√©e ! ‚ú®"
    ];
    return responses[Math.floor(Math.random() * responses.length)];
  };

  const sendMessage = (sender, text) => {
    setMessages((prev) => [...prev, { sender, text }]);
  };

  const getRandomEncouragement = () => {
    return encouragingMessages[Math.floor(Math.random() * encouragingMessages.length)];
  };

  const playNotificationSound = () => {
    try {
      const audioContext = new (window.AudioContext || window.webkitAudioContext)();
      const oscillator = audioContext.createOscillator();
      const gainNode = audioContext.createGain();

      oscillator.connect(gainNode);
      gainNode.connect(audioContext.destination);

      const now = audioContext.currentTime;

      oscillator.frequency.setValueAtTime(800, now);
      oscillator.frequency.setValueAtTime(600, now + 0.2);
      oscillator.frequency.setValueAtTime(800, now + 0.4);

      gainNode.gain.setValueAtTime(0.3, now);
      gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.6);

      oscillator.start(now);
      oscillator.stop(now + 0.6);

    } catch (error) {
      console.log('Son de notification non disponible');
    }
  };

  useEffect(() => {
    if (!hasPlayedSound) {
      const timer = setTimeout(() => {
        playNotificationSound();
        setHasPlayedSound(true);
      }, 2000);
      
      return () => clearTimeout(timer);
    }
  }, [hasPlayedSound]);

  const handleUserSubmit = (e) => {
    e.preventDefault();
    if (!userInput.trim()) return;

    sendMessage("user", userInput);
    const analysis = analyzeUserInput(userInput);
    
    setIsLoading(true);

    setTimeout(() => {
      setIsLoading(false);
      
      // Gestion des refus
      if (analysis.isRefusal) {
        setHasDeclined(true);
        setConversationMode('ai');
        sendMessage("bot", getRefusalResponse());
        setUserInput("");
        return;
      }

      // Gestion des questions d'immigration hors formulaire
      if (analysis.isImmigrationQuestion && conversationMode === 'form') {
        setConversationMode('ai');
        sendMessage("bot", getImmigrationResponse(userInput));
        
        setTimeout(() => {
          if (!hasDeclined) {
            sendMessage("bot", "Si vous souhaitez une √©valuation personnalis√©e gratuite, je peux vous poser quelques questions rapides. √ätes-vous d'accord ? üòä");
            setConversationMode('form');
          }
        }, 2000);
        setUserInput("");
        return;
      }

      // Gestion des sujets hors immigration
      if (analysis.isOffTopic) {
        setConversationMode('ai');
        sendMessage("bot", getOffTopicResponse());
        setUserInput("");
        return;
      }

      // Mode formulaire normal
      if (conversationMode === 'form' && step < questions.length) {
        const currentKey = questions[step]?.key;
        if (currentKey) {
          setForm((prev) => ({ ...prev, [currentKey]: userInput }));
        }

        if (step < questions.length - 1) {
          sendMessage("bot", getRandomEncouragement());
          
          setTimeout(() => {
            const nextStep = step + 1;
            setStep(nextStep);
            sendMessage("bot", questions[nextStep].text);
          }, 800);
        } else {
          setStep(questions.length);
          sendMessage("bot", "Merci beaucoup pour toutes ces informations ! üéâ");
          
          setTimeout(() => {
            sendMessage("bot", "J'ai pr√©par√© un formulaire personnalis√© avec vos r√©ponses. Un de nos conseillers experts pourra ainsi mieux vous accompagner dans votre projet d'immigration. Vous pouvez le consulter ci-dessous ! üìã‚ú®");
          }, 1500);
        }
      }

      setUserInput("");
    }, 1000 + Math.random() * 500);
  };

  useEffect(() => {
    if (chatBoxRef.current) {
      setTimeout(() => {
        chatBoxRef.current.scrollTop = chatBoxRef.current.scrollHeight;
      }, 100);
    }
  }, [messages, isLoading]);

  useEffect(() => {
    if (messages.length === 1 && step === 0 && conversationMode === 'form') {
      setTimeout(() => {
        sendMessage("bot", questions[0].text);
      }, 6000);
    }
  }, [messages, step, conversationMode]);

  const googleFormURL =
    `https://docs.google.com/forms/d/e/1FAIpQLSft6cT6hHWkXV-THzxZIAkoyOrlqneL2k5tV78dt3yybwiMJA/viewform?usp=pp_url` +
    `&entry.583938010=${encodeURIComponent(form.name || "")}` +
    `&entry.403275790=${encodeURIComponent(form.status || "")}` +
    `&entry.1000627390=${encodeURIComponent(form.email || "")}` +
    `&entry.1338088088=${encodeURIComponent(form.phone || "")}` +
    `&entry.213167345=${encodeURIComponent(form.program || "")}`;

  const renderInput = () => {
    if (hasDeclined) return null;
    
    // Mode IA - input libre
    if (conversationMode === 'ai') {
      return (
        <form onSubmit={handleUserSubmit} style={styles.form}>
          <input
            type="text"
            value={userInput}
            onChange={(e) => setUserInput(e.target.value)}
            placeholder="Posez-moi votre question..."
            style={styles.input}
            autoFocus
          />
          <button
            type="submit"
            style={styles.button}
            onMouseEnter={(e) => (e.currentTarget.style.backgroundColor = "#0e9e6e")}
            onMouseLeave={(e) => (e.currentTarget.style.backgroundColor = "#10B981")}
          >
            Envoyer
          </button>
        </form>
      );
    }

    // Mode formulaire
    if (step >= questions.length) return null;
    const currentQuestion = questions[step];
    if (!currentQuestion) return null;

    const commonButton = (
      <button
        type="submit"
        style={styles.button}
        onMouseEnter={(e) => (e.currentTarget.style.backgroundColor = "#0e9e6e")}
        onMouseLeave={(e) => (e.currentTarget.style.backgroundColor = "#10B981")}
      >
        Envoyer
      </button>
    );

    if (currentQuestion.type === "select") {
      return (
        <form onSubmit={handleUserSubmit} style={{ ...styles.form, flexDirection: "column", gap: "10px" }}>
          <select
            value={userInput}
            onChange={(e) => setUserInput(e.target.value)}
            style={styles.select}
            required
            autoFocus
          >
            <option value="" disabled>-- Choisissez une option --</option>
            {currentQuestion.options.map((opt, idx) => (
              <option key={idx} value={opt}>{opt}</option>
            ))}
          </select>
          {commonButton}
        </form>
      );
    }

    return (
      <form onSubmit={handleUserSubmit} style={styles.form}>
        <input
          type={currentQuestion.key === "email" ? "email" : "text"}
          value={userInput}
          onChange={(e) => setUserInput(e.target.value)}
          placeholder={currentQuestion.key === "email" ? "exemple@email.com" : "Votre r√©ponse..."}
          style={styles.input}
          autoFocus
          required
        />
        {commonButton}
      </form>
    );
  };

  return (
    <>
      <button
        onClick={() => setIsOpen((open) => !open)}
        style={styles.chatButton}
        aria-label={isOpen ? "Fermer le chat" : "Ouvrir le chat"}
        title={isOpen ? "Fermer le chat" : "Discuter avec Marie"}
      >
        {isOpen ? "√ó" : "üí¨"}
      </button>

      {isOpen && (
        <div style={styles.container} role="dialog" aria-modal="true" aria-labelledby="chat-header">
          <h3 id="chat-header" style={styles.header}>
            üë©‚Äçüíº Marie - Conseill√®re Immigration IA
          </h3>

          <div style={styles.chatBox} ref={chatBoxRef} tabIndex={-1}>
            {messages.map((msg, index) => (
              <div
                key={index}
                style={{
                  ...styles.message,
                  alignSelf: msg.sender === "user" ? "flex-end" : "flex-start",
                  backgroundColor: msg.sender === "user" ? "#DCF8C6" : "#F1F1F1",
                  borderRadius: msg.sender === "user" ? "18px 18px 5px 18px" : "18px 18px 18px 5px",
                }}
              >
                {msg.text}
              </div>
            ))}
            {isLoading && (
              <div style={styles.loader}>
                <div style={styles.typingIndicator}>
                  <span style={styles.typingText}>Marie r√©fl√©chit</span>
                  <div style={styles.typingDots}>
                    <span style={styles.dot}></span>
                    <span style={styles.dot}></span>
                    <span style={styles.dot}></span>
                  </div>
                </div>
              </div>
            )}
          </div>

          {!isLoading && renderInput()}

          {step === questions.length && !hasDeclined && (
            <div style={{ marginTop: "1rem", textAlign: "center" }}>
              <a
                href={googleFormURL}
                target="_blank"
                rel="noopener noreferrer"
                style={styles.formLink}
              >
                üìã Voir mon formulaire de prise de contact
              </a>
              <p style={styles.footerText}>
                Un conseiller vous contactera sous 24h ! üïê
              </p>
            </div>
          )}

          {hasDeclined && (
            <div style={{ marginTop: "1rem", textAlign: "center" }}>
              <p style={styles.footerText}>
                Merci de votre visite ! N'h√©sitez pas √† revenir quand vous voulez. üòä
              </p>
            </div>
          )}
        </div>
      )}
    </>
  );
};

const styles = {
  chatButton: {
    position: "fixed",
    bottom: 40,
    right: 20,
    zIndex: 1100,
    backgroundColor: "#10B981",
    border: "none",
    borderRadius: "50%",
    width: 56,
    height: 56,
    color: "white",
    fontSize: 28,
    cursor: "pointer",
    boxShadow: "0 4px 12px rgba(16,185,129,0.4)",
    display: "flex",
    alignItems: "center",
    justifyContent: "center",
    transition: "all 0.3s ease",
    animation: "pulse 2s infinite ease-in-out, bounce 1s ease-out",
  },
  container: {
    position: "fixed",
    bottom: 90,
    right: 20,
    width: "90%",
    maxWidth: 380,
    maxHeight: 600,
    borderRadius: 16,
    overflow: "hidden",
    boxShadow: "0 8px 32px rgba(0,0,0,0.15)",
    backgroundColor: "#fff",
    fontFamily: "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif",
    display: "flex",
    flexDirection: "column",
    zIndex: 1050,
    border: "1px solid #e5e7eb",
    animation: "slideInUp 0.5s ease-out",
  },
  header: {
    margin: 0,
    padding: "16px 20px",
    background: "linear-gradient(135deg, #10B981 0%, #059669 100%)",
    color: "white",
    fontSize: "1.1rem",
    fontWeight: "600",
    textAlign: "center",
  },
  chatBox: {
    flex: 1,
    padding: "16px",
    overflowY: "auto",
    display: "flex",
    flexDirection: "column",
    gap: "12px",
    maxHeight: "300px",
    backgroundColor: "#f9fafb",
  },
  message: {
    padding: "12px 16px",
    maxWidth: "85%",
    wordBreak: "break-word",
    fontSize: "0.95rem",
    lineHeight: 1.5,
    boxShadow: "0 1px 2px rgba(0,0,0,0.1)",
    animation: "slideIn 0.3s ease-out",
  },
  form: {
    display: "flex",
    padding: "16px",
    gap: "12px",
    borderTop: "1px solid #e5e7eb",
    alignItems: "center",
    backgroundColor: "white",
  },
  input: {
    flex: 1,
    padding: "12px 16px",
    borderRadius: 12,
    border: "2px solid #e5e7eb",
    fontSize: "1rem",
    outline: "none",
    transition: "border-color 0.2s ease",
  },
  select: {
    flex: 1,
    padding: "12px 16px",
    borderRadius: 12,
    border: "2px solid #e5e7eb",
    fontSize: "1rem",
    backgroundColor: "white",
    outline: "none",
    appearance: "none",
    cursor: "pointer",
  },
  button: {
    padding: "12px 24px",
    backgroundColor: "#10B981",
    color: "white",
    border: "none",
    borderRadius: 12,
    cursor: "pointer",
    fontWeight: "600",
    fontSize: "0.95rem",
    transition: "all 0.2s ease",
    boxShadow: "0 2px 4px rgba(16,185,129,0.3)",
  },
  formLink: {
    display: "inline-block",
    backgroundColor: "#10B981",
    color: "white",
    padding: "12px 20px",
    borderRadius: 12,
    textDecoration: "none",
    fontWeight: "600",
    fontSize: "0.95rem",
    transition: "all 0.2s ease",
    boxShadow: "0 2px 8px rgba(16,185,129,0.3)",
  },
  footerText: {
    fontSize: "0.85rem",
    color: "#6b7280",
    marginTop: "8px",
    marginBottom: 0,
  },
  loader: {
    display: "flex",
    alignItems: "center",
    padding: "8px 16px",
    alignSelf: "flex-start",
  },
  typingIndicator: {
    display: "flex",
    alignItems: "center",
    gap: "8px",
    backgroundColor: "#F1F1F1",
    padding: "12px 16px",
    borderRadius: "18px 18px 18px 5px",
    fontSize: "0.9rem",
    color: "#6b7280",
  },
  typingText: {
    fontStyle: "italic",
  },
  typingDots: {
    display: "flex",
    gap: "3px",
  },
  dot: {
    width: 6,
    height: 6,
    backgroundColor: "#10B981",
    borderRadius: "50%",
    animation: "bounce 1.4s infinite both",
  },
};

// Ajout des animations CSS via une balise style
const styleSheet = document.createElement("style");
styleSheet.textContent = `
  @keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.05); }
    100% { transform: scale(1); }
  }
  
  @keyframes bounce {
    0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
    40% { transform: translateY(-10px); }
    60% { transform: translateY(-5px); }
  }
  
  @keyframes slideInUp {
    from { 
      opacity: 0; 
      transform: translateY(30px); 
    }
    to { 
      opacity: 1; 
      transform: translateY(0); 
    }
  }
  
  @keyframes slideIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }
  
  @keyframes bounce {
    0%, 80%, 100% { transform: scale(0); }
    40% { transform: scale(1); }
  }
  
  .dot:nth-child(1) { animation-delay: -0.32s; }
  .dot:nth-child(2) { animation-delay: -0.16s; }
  .dot:nth-child(3) { animation-delay: 0s; }
`;
document.head.appendChild(styleSheet);

export default AssistantChat;